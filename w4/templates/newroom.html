<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waiting for Player</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Secular+One&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        .container1 {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.75); /* Semi-transparent background */
    color: white;
    text-align: center;
    font-size: 24px;
    padding-top: 20vh; /* Center vertically */
    overflow-y: auto;
}
.popup-content {
    background-color: rgba(0, 0, 0, 0.9);
    margin: 0 auto;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
}

        .code {
            font-size: 24px;
            margin-bottom: 20px;
        }

         #board{
  width:350px;
  height:420px;
  background-color: white;
  margin:0 auto;
  margin-top: 3px;
  display:flex;
  flex-wrap:wrap;
  }
.tile{
border: 2px solid black;
width:60px;
height:60px;
margin:2.5px;

color:black;
font-size: 35px;
display:flex;
justify-content: center;
align-items: center;
font-family:Secular One;

}

.correct{
background-color: #6AAA64;
color:black;
border-color:black;
}

.present{
background-color: #C9B458;
color:black;
border-color:black;
}

.absent{
background-color: #787C7E;
color:black;
border-color:black;
}

.keyboard-row{
width:400px;
margin:0 auto;
display:flex;
flex-wrap: wrap;

}

.key-tile{
border: 1px solid black;
width:36px;
height:40px;
margin:1px;
font-family:Secular One;


font-size: 20px;
display:flex;
justify-content: center;
align-items: center;
}

.enter-key-tile{
border: 1px solid black;
width:70px;
height:40px;
margin:1px;


font-size: 20px;
display:flex;
justify-content: center;
align-items: center;
font-family:Secular One;

}

.button-class1 {
            display: inline-block;
            padding: 5px 10px;
            margin: 7px;
            background-color: #C9B458;
            color: black;
            text-decoration: none;
            font-size: 18px;
            border: solid black 3px;
            cursor: pointer;
            font-family: Secular One;
        }
        .button-class1:disabled {
            display: inline-block;
            padding: 5px 10px;
            margin: 7px;
            background-color: #C9B458;
            color: lightgray;
            opacity: 0.6;
            text-decoration: none;
            font-size: 18px;
            border: solid black 3px;
            cursor: pointer;
            font-family: Secular One;
        }




    </style>
</head>
<body>
    <div id="player-info">
        <p id="player-indicator" style="font-family: 'Secular One';"></p>
        <p id="player1-score" style="font-family: 'Secular One';">Player 1: 0</p>
        <p id="player2-score" style="font-family: 'Secular One';">Player 2: 0</p>
    </div>

    <div class="container1" id="waiting-screen">
        <img src="static/wordual_logo_1.svg" alt="Wordual Logo" class="logo">
        <h1>Waiting for Other Player...</h1>
        <p>Your game code:</p>
        <div class="code" style="font-family: 'Secular One';">{{ game_code }}</div>
    </div>

    <div id="game-container" style="display:none;">
        <div id="board"></div>
        <p id="answer" style="font-family: 'Secular One';"></p>
        <button id="peekButton" disabled class="button-class1">Peek</button>
        <div id="popupDiv" class="popup"></div>
        <h3 id="game-result" style="font-family: 'Secular One';"></h3>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <script>
       // Game configuration
const height = 6;
const width = 5;
const roomCode = "{{ game_code }}";
const playerId = "{{ player_id }}";
const opponentId = "{{ opponent_id }}";

// Game state
let word = "";
let score = 0;
let opponentScore = 0;
let row = 0;
let col = 0;
let gameOver = false;
let buttonClicked = false;
let opponentNickname = `Player ${opponentId}`;

guessList = guessList.concat(wordList);


const socket = io(window.location.origin, { transports: ['websocket'] });

  socket.on('connect', () => {
      console.log('socket connected', socket.id);
      // emit join_game so server registers this player
      socket.emit('join_game', {
          room_code: roomCode,
          player_id: playerId,
          nickname: `Player ${playerId}`
      });
  });

  socket.on('game_start', function(data) {
      console.log('game_start received', data);
      word = data.word;
      initializeGame();
      document.getElementById("waiting-screen").style.display = "none";
      document.getElementById("game-container").style.display = "block";
      document.getElementById("player-indicator").textContent = `You are Player ${playerId}`;
  });

  socket.on('player_joined', function(data) {
      if (data.player_id === opponentId) {
          opponentNickname = data.nickname || `Player ${opponentId}`;
          document.getElementById(`player${opponentId}-score`).textContent = `${opponentNickname}: 0`;
      }
  });

  socket.on('score_update', function(data) {
      if (data.player_id === playerId) {
          score = data.score;
          document.getElementById(`player${playerId}-score`).textContent = `You: ${score}`;
      } else {
          opponentScore = data.score;
          document.getElementById(`player${opponentId}-score`).textContent = `${opponentNickname}: ${opponentScore}`;
      }
      updateButtonState();
  });

  socket.on('receive_peek', function(data) { showPopup(data.board); });
  socket.on('game_result', function(data) {
      gameOver = true;
      document.getElementById("game-result").textContent = data.message;
  });

  socket.on('player_left', function() {
      alert(`${opponentNickname} has disconnected!`);
      gameOver = true;
  });

  function updateButtonState() {
      const peekButton = document.getElementById('peekButton');
      // enable peek only when strictly ahead and not yet used
      peekButton.disabled = buttonClicked || !(score > opponentScore);
  }

// Initialize game board
function initializeGame() {
    // Create game board
    for (let r = 0; r < height; r++) {
        for (let c = 0; c < width; c++) {
            const tile = document.createElement("span");
            tile.id = `${r}-${c}`;
            tile.classList.add("tile");
            document.getElementById("board").appendChild(tile);
        }
    }

    // Create keyboard
    const keyboard = [
        ["Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P"],
        ["A", "S", "D", "F", "G", "H", "J", "K", "L"],
        ["Enter", "Z", "X", "C", "V", "B", "N", "M", "⌫"]
    ];

    keyboard.forEach(row => {
        const rowElement = document.createElement("div");
        rowElement.classList.add("keyboard-row");

        row.forEach(key => {
            const keyElement = document.createElement("div");
            keyElement.textContent = key;

            if (key === "Enter") {
                keyElement.id = "Enter";
                keyElement.classList.add("enter-key-tile");
            } else if (key === "⌫") {
                keyElement.id = "Backspace";
                keyElement.classList.add("key-tile");
            } else {
                keyElement.id = `Key${key}`;
                keyElement.classList.add("key-tile");
            }

            keyElement.addEventListener("click", () => processKey(keyElement));
            rowElement.appendChild(keyElement);
        });

        document.body.appendChild(rowElement);
    });

    // Add keyboard event listener
    document.addEventListener("keyup", processInput);
}

// Process keyboard input
function processInput(e) {
    if (gameOver) return;

    if (e.code.startsWith("Key") && e.code.length === 4) {
        const letter = e.code[3];
        if (col < width) {
            const tile = document.getElementById(`${row}-${col}`);
            if (!tile.textContent) {
                tile.textContent = letter;
                col++;
            }
        }
    } else if (e.code === "Backspace") {
        if (col > 0) {
            col--;
            const tile = document.getElementById(`${row}-${col}`);
            tile.textContent = "";
        }
    } else if (e.code === "Enter") {
        checkGuess();
    }
}

// Process virtual keyboard input
function processKey(keyElement) {
    const fakeEvent = { code: keyElement.id };
    processInput(fakeEvent);
}

// Check the current guess
function checkGuess() {
    let guess = "";
    for (let c = 0; c < width; c++) {
        const tile = document.getElementById(`${row}-${c}`);
        guess += tile.textContent;
    }

    guess = guess.toLowerCase();
    if (!guessList.includes(guess)) {
        document.getElementById("answer").textContent = "Not in word list";
        return;
    }

    document.getElementById("answer").textContent = "";

    // Check letters
    const letterCount = {};
    for (const letter of word) {
        letterCount[letter] = (letterCount[letter] || 0) + 1;
    }

    // First pass: check correct letters
    let correct = 0;
    for (let c = 0; c < width; c++) {
        const tile = document.getElementById(`${row}-${c}`);
        const letter = tile.textContent;

        if (word[c] === letter) {
            tile.classList.add("correct");
            correct++;
            letterCount[letter]--;
            score += 50;

            const keyTile = document.getElementById(`Key${letter}`);
            keyTile.classList.remove("present");
            keyTile.classList.add("correct");
        }
    }

    // Second pass: check present letters
    for (let c = 0; c < width; c++) {
        const tile = document.getElementById(`${row}-${c}`);
        const letter = tile.textContent;

        if (!tile.classList.contains("correct")) {
            if (word.includes(letter) && letterCount[letter] > 0) {
                tile.classList.add("present");
                score += 25;
                letterCount[letter]--;

                const keyTile = document.getElementById(`Key${letter}`);
                if (!keyTile.classList.contains("correct")) {
                    keyTile.classList.add("present");
                }
            } else {
                tile.classList.add("absent");
                const keyTile = document.getElementById(`Key${letter}`);
                keyTile.classList.add("absent");
            }
        }
    }

    // Update board state on server
    socket.emit("update_board", {
        board: document.getElementById("board").innerHTML
    });

    // Check for win/loss
    if (correct === width) {
        gameOver = true;
        socket.emit("game_over", { winner_id: playerId });
        document.getElementById("game-result").textContent = "You won!";
    } else if (row === height - 1) {
        gameOver = true;
        socket.emit("game_over", { winner_id: opponentId });
        document.getElementById("game-result").textContent = "You lost!";
        document.getElementById("answer").textContent = `The word was: ${word}`;
    } else {
        row++;
        col = 0;
    }

    // Update score
    socket.emit("update_score", { score: score });
}

// Update peek button state
function updateButtonState() {
    const peekButton = document.getElementById('peekButton');
    peekButton.disabled = buttonClicked || score >= opponentScore;
}

// Show opponent's board
function showPopup(content) {
    const popup = document.getElementById('popupDiv');
    popup.innerHTML = `
        <div class="popup-content">
            <h3 style="font-family: 'Secular One'; margin-bottom: 20px;">${opponentNickname}'s Board</h3>
            <div style="width:350px; height:420px; background-color: white; margin:0 auto; display:flex; flex-wrap:wrap;">
                ${content}
            </div>
            <p style="margin-top: 20px; color: #ccc;">Click anywhere to close</p>
        </div>
    `;
    popup.style.display = 'block';
    
    popup.onclick = () => {
        popup.style.display = 'none';
    };
    
    setTimeout(() => {
        popup.style.display = 'none';
    }, 5000);
}
// Peek at opponent's board
document.getElementById('peekButton').addEventListener('click', () => {
    buttonClicked = true;
    updateButtonState();
    socket.emit("request_peek");
});

// Initialize button state
updateButtonState();
    </script>
</body>
</html>